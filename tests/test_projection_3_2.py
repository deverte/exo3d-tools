import pathlib

import numpy as np
import pytest

import exo3d_tools as e3


def test_projection_3_2(make_data_3d):
    Rmax = 70.0
    nR = 4
    nF = 3
    d3: e3.Data3D = make_data_3d(
        Rmax=Rmax,
        nR=nR,
        nF=nF,
        nTet=2,
        keys=["H1a.Pn", "H1p.Vr"],
    )

    d2 = d3.to_2d()

    r_n = np.linspace(1.0 + 0.001 * Rmax, Rmax, nR + 1)
    phi_n = np.linspace(0.0, 2.0 * np.pi, nF + 1)
    assert (d2.grid.n[0] == np.meshgrid(phi_n, r_n)[0]).all()
    assert (d2.grid.n[1] == np.meshgrid(phi_n, r_n)[1]).all()
    array_H1aPn = np.array([
        [0.7580877400853738, 0.19463870785196757, 0.7447621559078171, 0.1894713590842857],
        [0.35452596812986836, 0.4667210037270342, 0.96750973243421, 0.12992150533547164],
        [0.9706980243949033, 0.04380376578722878, 0.32582535813815194, 0.47570492622593374],
        [0.8931211213221977, 0.15428949206754783, 0.3704597060348689, 0.2269093490508841],
        [0.7783834970737619, 0.6830489532424546, 0.4695558112758079, 0.6698139946825103],
    ]).T
    assert (d2.arrays["H1a.Pn"] == array_H1aPn).all()
    array_H1pVr = np.array([
        [0.908580690707607, 0.7168901891589956, 0.45577628983361107, 0.8566142840923755],
        [0.6997071338107496, 0.44936150214378867, 0.20236336479523032, 0.7585195298352101],
        [0.2658699614595196, 0.272241561845159, 0.3059566241506525, 0.7194629559509368],
        [0.9691763773477239, 0.0963909621534993, 0.579219568941896, 0.4320930397751037],
        [0.7787509039657946, 0.9026023965438417, 0.1767727829392317, 0.6273088407024432],
    ]).T
    assert (d2.arrays["H1p.Vr"] == array_H1pVr).all()